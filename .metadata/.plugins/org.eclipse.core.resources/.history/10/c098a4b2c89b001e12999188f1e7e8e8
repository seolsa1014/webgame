<%@ page import="java.sql.*, java.io.*, java.util.*" %>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ page import="org.json.simple.parser.JSONParser" %>
<%@ page import="org.json.simple.parser.ParseException" %>

<%
    String name = request.getParameter("name");
    String retrievedName = "";
    String retrievedSequence = "";

    Connection conn = null;
    PreparedStatement retrieveStmt = null;
    PreparedStatement deleteStmt = null;
    PreparedStatement insertStmt = null;
    ResultSet retrieveResultSet = null;

    try {
        Class.forName("com.mysql.cj.jdbc.Driver");
        conn = DriverManager.getConnection("jdbc:mysql://localhost:3306/websitedb", "root", "690505");

        // Retrieve name and sequence from the users table
        String retrieveQuery = "SELECT name, sequence FROM users WHERE name = ?";
        retrieveStmt = conn.prepareStatement(retrieveQuery);
        retrieveStmt.setString(1, name);
        retrieveResultSet = retrieveStmt.executeQuery();

        if (retrieveResultSet.next()) {
            retrievedName = retrieveResultSet.getString("name");
            retrievedSequence = retrieveResultSet.getString("sequence");

            // Delete existing row in the login table
            String deleteQuery = "DELETE FROM login WHERE name = ?";
            deleteStmt = conn.prepareStatement(deleteQuery);
            deleteStmt.setString(1, name);
            deleteStmt.executeUpdate();

            // Insert a new row in the login table
            String insertQuery = "INSERT INTO login (name) VALUES (?)";
            insertStmt = conn.prepareStatement(insertQuery);
            insertStmt.setString(1, name);
            insertStmt.executeUpdate();

            // Store name and sequence in local storage or perform other actions as needed

            // Redirect to lobby.jsp
            %>
            <script>
                window.location.href = 'lobby.jsp';
            </script>
            <%
        } else {
            // Name doesn't exist, display a message or perform additional actions
            %>
            <script>
                alert('Name does not exist. Please try again.');
                window.location.href = 'load.jsp';
            </script>
            <%
        }
    } catch (ClassNotFoundException | SQLException e) {
        e.printStackTrace();
    } finally {
        try {
            if (retrieveResultSet != null) retrieveResultSet.close();
            if (retrieveStmt != null) retrieveStmt.close();
            if (deleteStmt != null) deleteStmt.close();
            if (insertStmt != null) insertStmt.close();
            if (conn != null) conn.close();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
%>

